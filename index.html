<!-- ★★★ 完成版 index.html（抜粋）★★★ -->
<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>手書きメモ → Word変換</title>

<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.4.0/docx.umd.min.js" defer></script>

<!-- ★スタイルは省略（そのままで可） -->
<style> … </style>
</head><body>
<div class="container">
  <!-- 画面部品はそのまま -->
</div>

<script defer>
let currentImage=null;

const imgInput   = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImage');
const textArea   = document.getElementById('textOutput');
const processing = document.getElementById('processingIndicator');
const section    = document.getElementById('previewSection');

imgInput.addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f) return;
  if(f.size>5*1024*1024){alert('5 MB までです');return;}
  currentImage=f;
  previewImg.src=URL.createObjectURL(f);
  section.style.display='block';
  textArea.value='';
});

async function processImage(){
  if(!currentImage){alert('画像を選択してください');return;}

  processing.style.display='block';
  processing.innerHTML='<div class="spinner"></div><p>初期化中...</p>';

  const {data:{text}} = await Tesseract.recognize(
    currentImage,
    'jpn+eng',
    {
      corePath  :'https://unpkg.com/tesseract.js-core@4.0.2/tesseract-core.wasm.js',
      workerPath:'https://unpkg.com/tesseract.js@4.1.1/dist/worker.min.js',
      langPath  :'https://tessdata.projectnaptha.com/4.0.0',
      logger:m=>{
        if(m.status==='recognizing text'){
          processing.innerHTML=`<div class="spinner"></div><p>テキスト認識中... ${Math.round(m.progress*100)}%</p>`;
        }
      }
    }
  );

  textArea.value=text;
  processing.style.display='none';
  if(!text.trim()) alert('テキストを認識できませんでした');
}

async function downloadWord(){
  const txt=textArea.value.trim();
  if(!txt){alert('テキストがありません');return;}

  const {Document,Packer,Paragraph,TextRun}=docx;
  const paragraphs=txt.split(/\r?\n/).map(l=>new Paragraph({children:[new TextRun(l)]}));
  const doc=new Document({sections:[{children:paragraphs}]});
  const blob=await Packer.toBlob(doc);

  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(blob),
    download:`手書きメモ_${new Date().toISOString().slice(0,10)}.docx`
  });
  document.body.appendChild(a);a.click();a.remove();
}

function resetForm(){
  currentImage=null;imgInput.value='';
  section.style.display='none';processing.style.display='none';textArea.value='';
}

window.processImage  = processImage;
window.downloadWord  = downloadWord;
window.resetForm     = resetForm;
</script>
</body></html>
