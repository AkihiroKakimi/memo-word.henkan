<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>æ‰‹æ›¸ããƒ¡ãƒ¢â†’Wordå¤‰æ›</title>

<!-- ========== ãƒ©ã‚¤ãƒ–ãƒ©ãƒª ========== -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js" defer></script>

<!-- ========== ã‚¹ã‚¿ã‚¤ãƒ« ========== -->
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Segoe UI",Roboto}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:25px}
.container{max-width:1080px;margin:auto;background:rgba(255,255,255,.95);border-radius:18px;box-shadow:0 18px 38px rgba(0,0,0,.1);padding:40px}
h1{text-align:center;font-size:2.4em;font-weight:700;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.subtitle{text-align:center;color:#555;margin-bottom:32px}
.lang-wrap{display:flex;align-items:center;justify-content:center;margin-bottom:20px;gap:10px;font-size:.9em;color:#444}
.lang-wrap select{padding:6px 12px;border:1px solid #bbb;border-radius:8px;font-size:.9em}
.upload-zone{border:2px dashed #bbb;border-radius:15px;padding:38px;text-align:center;transition:.3s;position:relative;margin-bottom:28px}
.upload-zone:hover{border-color:#667eea;background:#f0f4ff}
.upload-btn{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;border-radius:24px;padding:15px 36px;cursor:pointer;font-size:1.07em;box-shadow:0 4px 15px rgba(102,126,234,.3);transition:.3s}
.upload-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
.file-input{position:absolute;inset:0;opacity:0;cursor:pointer}
.preview-wrap{display:flex;gap:22px;flex-wrap:wrap}
.panel{flex:1 1 320px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 5px 14px rgba(0,0,0,.08)}
.panel img{width:100%;border-radius:8px}
textarea{width:100%;min-height:240px;border:1px solid #ddd;border-radius:8px;padding:14px;resize:vertical}
.controls{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:22px}
.btn{border:none;border-radius:24px;padding:12px 28px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;color:#fff}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2)}
.btn-success{background:#28a745}.btn-secondary{background:#6c757d}
.btn:hover{transform:translateY(-2px);opacity:.92}
.loading{display:none;text-align:center;margin:24px 0;color:#667eea}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:0 auto 10px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:8px;font-size:.9em;opacity:0;transition:.4s;white-space:pre}
.toast.show{opacity:.9}
</style>
</head><body>
<div class="container">
  <h1>âœï¸ æ‰‹æ›¸ããƒ¡ãƒ¢ â†’ Wordå¤‰æ›</h1>
  <p class="subtitle">å†™çœŸã«æ’®ã£ãŸãƒ¡ãƒ¢ã‚’ç·¨é›†å¯èƒ½ãª Word æ–‡æ›¸ã¸</p>

  <!-- ========= è¨€èªé¸æŠ ========= -->
  <div class="lang-wrap">
    <span>OCR è¨€èªï¼š</span>
    <select id="langSelect">
      <option value="jpn" selected>æ—¥æœ¬èªï¼ˆjpnï¼‰</option>
      <option value="eng">è‹±èªï¼ˆengï¼‰</option>
    </select>
    <small>â€»æ—¥æœ¬èªãƒ¢ãƒ‡ãƒ«ã¯åˆå›ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</small>
  </div>

  <!-- ========= ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ========= -->
  <div class="upload-zone">
    <div style="font-size:4em;margin-bottom:12px">ğŸ“¸</div>
    <input type="file" id="imageInput" accept="image/*" class="file-input">
    <button class="upload-btn" onclick="imageInput.click()">ç”»åƒã‚’é¸æŠ</button>
    <p style="margin-top:14px;color:#666">JPG / PNG / WebP  |  æœ€å¤§5&nbsp;MB</p>
  </div>

  <!-- ========= ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========= -->
  <div id="loading" class="loading">
    <div class="spinner"></div><p id="loadingMsg">ç”»åƒã‚’è§£æä¸­...</p>
  </div>

  <!-- ========= ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ========= -->
  <section id="previewSection" style="display:none">
    <div class="preview-wrap">
      <div class="panel">
        <h3>ğŸ“· ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ</h3>
        <img id="previewImage" alt="preview">
      </div>
      <div class="panel">
        <h3>ğŸ“ æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ</h3>
        <textarea id="textOutput" placeholder="ã“ã“ã«OCRçµæœãŒè¡¨ç¤º"></textarea>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="processImage()">ğŸ” ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º</button>
      <button class="btn btn-success" onclick="downloadWord()">ğŸ“„ Word ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn btn-secondary" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </section>
</div>

<!-- ========= ãƒˆãƒ¼ã‚¹ãƒˆ ========= -->
<div id="toast" class="toast"></div>

<!-- ========= ãƒ­ã‚¸ãƒƒã‚¯ ========= -->
<script>
/* DOM */
const imgInput   = document.getElementById('imageInput');
const previewIm  = document.getElementById('previewImage');
const previewSec = document.getElementById('previewSection');
const textArea   = document.getElementById('textOutput');
const loadingBox = document.getElementById('loading');
const loadingMsg = document.getElementById('loadingMsg');
const langSel    = document.getElementById('langSelect');
const toastBox   = document.getElementById('toast');

/* çŠ¶æ…‹ */
let currentFile = null;
let docxReady   = !!window.docx;
let toastTimer  = null;

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
function toast(msg,duration=3000){
  toastBox.textContent = msg;
  toastBox.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastBox.classList.remove('show'),duration);
}

/* ç”»åƒé¸æŠ */
imgInput.addEventListener('change',e=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > 5*1024*1024){toast('5 MB ä»¥å†…ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  currentFile = f;
  previewIm.src = URL.createObjectURL(f);
  previewSec.style.display = 'block';
  textArea.value = '';
});

/* ===== å‰å‡¦ç†ï¼šâ‘ è§£åƒåº¦ã‚¢ãƒƒãƒ— & â‘¡è»½ã„ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆè£œæ­£ï¼ˆç„¡äºŒå€¤åŒ–ï¼‰ ===== */
function preprocess(file){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>{
      /* â‘  1000px æœªæº€ãªã‚‰ 2 å€æ‹¡å¤§ï¼ˆç·šã‚’å¤ªã‚‰ã›ã¦ OCR ç²¾åº¦ã‚¢ãƒƒãƒ—ï¼‰ */
      const factor = Math.max(1, 1000 / Math.max(img.naturalWidth, img.naturalHeight));
      const W = Math.round(img.naturalWidth  * factor);
      const H = Math.round(img.naturalHeight * factor);

      const cvs = document.createElement('canvas');
      cvs.width = W; cvs.height = H;
      const ctx = cvs.getContext('2d');

      /* â‘¡ ã»ã‚“ã®å°‘ã—ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã¨æ˜åº¦ã‚’ä¸Šã’ã‚‹ */
      ctx.filter = 'brightness(1.1) contrast(1.2)';
      ctx.drawImage(img,0,0,W,H);

      cvs.toBlob(b=>res(b),'image/png');
    };
    img.src = URL.createObjectURL(file);
  });
}

/* ===== OCR ===== */
async function processImage(){
  if(!currentFile){toast('å…ˆã«ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');return;}

  loadingBox.style.display = 'block';
  loadingMsg.textContent   = 'ç”»åƒã‚’å‰å‡¦ç†ä¸­...';

  const blob = await preprocess(currentFile);
  const lang = langSel.value;

  async function recognize(langCode){
    loadingMsg.textContent = `OCR (${langCode}) ã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·å‹•ä¸­...`;
    return Tesseract.recognize(blob, langCode, {
      logger: m=>{
        if(m.status === 'recognizing text'){
          loadingMsg.innerHTML = `ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ä¸­... ${Math.round(m.progress*100)}%`;
        }
      },
      /* PSM=6: å‡ä¸€ãªãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯æƒ³å®šã€‚æ‰‹æ›¸ããƒ¡ãƒ¢ã«æœ€é© */
      langPath: 'https://tessdata.projectnaptha.com/4.0.0', // CDN ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿
      tessedit_pageseg_mode: 6
    });
  }

  try{
    let result;
    try{
      result = await recognize(lang);
    }catch(e){
      if(lang!=='eng'){
        toast('æ—¥æœ¬èªãƒ¢ãƒ‡ãƒ«ã§å¤±æ•— â†’ è‹±èªãƒ¢ãƒ‡ãƒ«ã§å†è©¦è¡Œ',4000);
        result = await recognize('eng');
      }else throw e;
    }
    const txt = result.data.text.replace(/\s+$/,''); // æœ«å°¾æ”¹è¡Œå‰Šé™¤
    textArea.value = txt;
    if(!txt) toast('æ–‡å­—ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ',4000);
  }catch(err){
    console.error(err);
    toast('OCR ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }finally{
    loadingBox.style.display = 'none';
  }
}

/* ===== Word ===== */
async function ensureDocx(){
  if(docxReady) return;
  await new Promise((ok,ng)=>{
    const s = document.createElement('script');
    s.src   = 'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js';
    s.onload= ()=>{docxReady=true;ok();};
    s.onerror= ng;
    document.head.appendChild(s);
  });
}

async function downloadWord(){
  const txt = textArea.value.trim();
  if(!txt){toast('ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}

  await ensureDocx();

  if(window.docx){
    try{
      const {Document,Packer,Paragraph,TextRun} = docx;
      const paras = txt.split(/\r?\n/).map(l=>new Paragraph({children:[new TextRun(l)]}));
      const doc   = new Document({sections:[{children:paras}]});
      const blob  = await Packer.toBlob(doc);
      const href  = URL.createObjectURL(blob);
      const a     = document.createElement('a');
      a.href = href;
      a.download = `handwriting_${Date.now()}.docx`;
      document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(href);
      return;
    }catch(e){console.error(e);}
  }

  /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ RTF */
  toast('docx èª­ã¿è¾¼ã¿å¤±æ•— â†’ RTF ã§ä¿å­˜ã—ã¾ã™',4000);
  const rtf  = `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0 ${txt.replace(/\n/g,'\\par ')}}`;
  const blob = new Blob([rtf],{type:'application/rtf'});
  const link = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = link;a.download=`handwriting_${Date.now()}.rtf`;
  document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(link);
}

/* ===== Reset ===== */
function resetAll(){
  currentFile = null;
  imgInput.value = '';
  previewSec.style.display = 'none';
  textArea.value = '';
}
</script>
</body>
</html>
