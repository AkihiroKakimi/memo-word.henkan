<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>手書きメモ→Word変換</title>

<!-- ========== ライブラリ ========== -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js" defer></script>

<!-- ========== スタイル ========== -->
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Segoe UI",Roboto}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:25px}
.container{max-width:1080px;margin:auto;background:rgba(255,255,255,.95);border-radius:18px;box-shadow:0 18px 38px rgba(0,0,0,.1);padding:40px}
h1{text-align:center;font-size:2.4em;font-weight:700;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.subtitle{text-align:center;color:#555;margin-bottom:32px}
.lang-wrap{display:flex;align-items:center;justify-content:center;margin-bottom:20px;gap:10px;font-size:.9em;color:#444}
.lang-wrap select{padding:6px 12px;border:1px solid #bbb;border-radius:8px;font-size:.9em}
.upload-zone{border:2px dashed #bbb;border-radius:15px;padding:38px;text-align:center;transition:.3s;position:relative;margin-bottom:28px}
.upload-zone:hover{border-color:#667eea;background:#f0f4ff}
.upload-btn{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;border-radius:24px;padding:15px 36px;cursor:pointer;font-size:1.07em;box-shadow:0 4px 15px rgba(102,126,234,.3);transition:.3s}
.upload-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
.file-input{position:absolute;inset:0;opacity:0;cursor:pointer}
.preview-wrap{display:flex;gap:22px;flex-wrap:wrap}
.panel{flex:1 1 320px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 5px 14px rgba(0,0,0,.08)}
.panel img{width:100%;border-radius:8px}
textarea{width:100%;min-height:240px;border:1px solid #ddd;border-radius:8px;padding:14px;resize:vertical}
.controls{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:22px}
.btn{border:none;border-radius:24px;padding:12px 28px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;color:#fff}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2)}
.btn-success{background:#28a745}.btn-secondary{background:#6c757d}
.btn:hover{transform:translateY(-2px);opacity:.92}
.loading{display:none;text-align:center;margin:24px 0;color:#667eea}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:0 auto 10px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:8px;font-size:.9em;opacity:0;transition:.4s;white-space:pre}
.toast.show{opacity:.9}
</style>
</head><body>
<div class="container">
  <h1>✍️ 手書きメモ → Word変換</h1>
  <p class="subtitle">写真に撮ったメモを編集可能な Word 文書へ</p>

  <!-- ========= 言語選択 ========= -->
  <div class="lang-wrap">
    <span>OCR 言語：</span>
    <select id="langSelect">
      <option value="jpn" selected>日本語（jpn）</option>
      <option value="eng">英語（eng）</option>
    </select>
    <small>※日本語モデルは初回ダウンロードに時間がかかります</small>
  </div>

  <!-- ========= アップロード ========= -->
  <div class="upload-zone">
    <div style="font-size:4em;margin-bottom:12px">📸</div>
    <input type="file" id="imageInput" accept="image/*" class="file-input">
    <button class="upload-btn" onclick="imageInput.click()">画像を選択</button>
    <p style="margin-top:14px;color:#666">JPG / PNG / WebP  |  最大5&nbsp;MB</p>
  </div>

  <!-- ========= ローディング ========= -->
  <div id="loading" class="loading">
    <div class="spinner"></div><p id="loadingMsg">画像を解析中...</p>
  </div>

  <!-- ========= プレビュー ========= -->
  <section id="previewSection" style="display:none">
    <div class="preview-wrap">
      <div class="panel">
        <h3>📷 アップロード画像</h3>
        <img id="previewImage" alt="preview">
      </div>
      <div class="panel">
        <h3>📝 抽出されたテキスト</h3>
        <textarea id="textOutput" placeholder="ここにOCR結果が表示"></textarea>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="processImage()">🔍 テキスト抽出</button>
      <button class="btn btn-success" onclick="downloadWord()">📄 Word ダウンロード</button>
      <button class="btn btn-secondary" onclick="resetAll()">🔄 リセット</button>
    </div>
  </section>
</div>

<!-- ========= トースト ========= -->
<div id="toast" class="toast"></div>

<!-- ========= ロジック ========= -->
<script>
/* DOM */
const imgInput   = document.getElementById('imageInput');
const previewIm  = document.getElementById('previewImage');
const previewSec = document.getElementById('previewSection');
const textArea   = document.getElementById('textOutput');
const loadingBox = document.getElementById('loading');
const loadingMsg = document.getElementById('loadingMsg');
const langSel    = document.getElementById('langSelect');
const toastBox   = document.getElementById('toast');

/* 状態 */
let currentFile = null;
let docxReady   = !!window.docx;
let toastTimer  = null;

/* トースト */
function toast(msg,duration=3000){
  toastBox.textContent = msg;
  toastBox.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastBox.classList.remove('show'),duration);
}

/* 画像選択 */
imgInput.addEventListener('change',e=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > 5*1024*1024){toast('5 MB 以内の画像を選択してください');return;}
  currentFile = f;
  previewIm.src = URL.createObjectURL(f);
  previewSec.style.display = 'block';
  textArea.value = '';
});

/* ===== 前処理：①解像度アップ & ②軽いコントラスト補正（無二値化） ===== */
function preprocess(file){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>{
      /* ① 1000px 未満なら 2 倍拡大（線を太らせて OCR 精度アップ） */
      const factor = Math.max(1, 1000 / Math.max(img.naturalWidth, img.naturalHeight));
      const W = Math.round(img.naturalWidth  * factor);
      const H = Math.round(img.naturalHeight * factor);

      const cvs = document.createElement('canvas');
      cvs.width = W; cvs.height = H;
      const ctx = cvs.getContext('2d');

      /* ② ほんの少しコントラストと明度を上げる */
      ctx.filter = 'brightness(1.1) contrast(1.2)';
      ctx.drawImage(img,0,0,W,H);

      cvs.toBlob(b=>res(b),'image/png');
    };
    img.src = URL.createObjectURL(file);
  });
}

/* ===== OCR ===== */
async function processImage(){
  if(!currentFile){toast('先に画像を選択してください');return;}

  loadingBox.style.display = 'block';
  loadingMsg.textContent   = '画像を前処理中...';

  const blob = await preprocess(currentFile);
  const lang = langSel.value;

  async function recognize(langCode){
    loadingMsg.textContent = `OCR (${langCode}) エンジンを起動中...`;
    return Tesseract.recognize(blob, langCode, {
      logger: m=>{
        if(m.status === 'recognizing text'){
          loadingMsg.innerHTML = `テキスト認識中... ${Math.round(m.progress*100)}%`;
        }
      },
      /* PSM=6: 均一なテキストブロック想定。手書きメモに最適 */
      langPath: 'https://tessdata.projectnaptha.com/4.0.0', // CDN の学習データ
      tessedit_pageseg_mode: 6
    });
  }

  try{
    let result;
    try{
      result = await recognize(lang);
    }catch(e){
      if(lang!=='eng'){
        toast('日本語モデルで失敗 → 英語モデルで再試行',4000);
        result = await recognize('eng');
      }else throw e;
    }
    const txt = result.data.text.replace(/\s+$/,''); // 末尾改行削除
    textArea.value = txt;
    if(!txt) toast('文字を認識できませんでした',4000);
  }catch(err){
    console.error(err);
    toast('OCR でエラーが発生しました');
  }finally{
    loadingBox.style.display = 'none';
  }
}

/* ===== Word ===== */
async function ensureDocx(){
  if(docxReady) return;
  await new Promise((ok,ng)=>{
    const s = document.createElement('script');
    s.src   = 'https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js';
    s.onload= ()=>{docxReady=true;ok();};
    s.onerror= ng;
    document.head.appendChild(s);
  });
}

async function downloadWord(){
  const txt = textArea.value.trim();
  if(!txt){toast('テキストがありません');return;}

  await ensureDocx();

  if(window.docx){
    try{
      const {Document,Packer,Paragraph,TextRun} = docx;
      const paras = txt.split(/\r?\n/).map(l=>new Paragraph({children:[new TextRun(l)]}));
      const doc   = new Document({sections:[{children:paras}]});
      const blob  = await Packer.toBlob(doc);
      const href  = URL.createObjectURL(blob);
      const a     = document.createElement('a');
      a.href = href;
      a.download = `handwriting_${Date.now()}.docx`;
      document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(href);
      return;
    }catch(e){console.error(e);}
  }

  /* フォールバック RTF */
  toast('docx 読み込み失敗 → RTF で保存します',4000);
  const rtf  = `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0 ${txt.replace(/\n/g,'\\par ')}}`;
  const blob = new Blob([rtf],{type:'application/rtf'});
  const link = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = link;a.download=`handwriting_${Date.now()}.rtf`;
  document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(link);
}

/* ===== Reset ===== */
function resetAll(){
  currentFile = null;
  imgInput.value = '';
  previewSec.style.display = 'none';
  textArea.value = '';
}
</script>
</body>
</html>
