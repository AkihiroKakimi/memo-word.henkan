<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>手書きメモ→Word変換</title>

<!-- ========== 必要ライブラリ（ロード失敗時は後で動的リトライ） ========== -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js" defer></script>

<!-- ========== ざっくりデザイン ========== -->
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Segoe UI",Roboto}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:25px}
.container{max-width:1080px;margin:auto;background:rgba(255,255,255,.95);border-radius:18px;box-shadow:0 18px 38px rgba(0,0,0,.1);padding:40px}
h1{text-align:center;font-size:2.4em;font-weight:700;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.subtitle{text-align:center;color:#555;margin-bottom:32px}
.upload-zone{border:2px dashed #bbb;border-radius:15px;padding:38px;text-align:center;transition:.3s;position:relative;margin-bottom:28px}
.upload-zone:hover{border-color:#667eea;background:#f0f4ff}
.upload-btn{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;border-radius:24px;padding:15px 36px;cursor:pointer;font-size:1.07em;box-shadow:0 4px 15px rgba(102,126,234,.3);transition:.3s}
.upload-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
.file-input{position:absolute;inset:0;opacity:0;cursor:pointer}
.preview-wrap{display:flex;gap:22px;flex-wrap:wrap}
.panel{flex:1 1 320px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 5px 14px rgba(0,0,0,.08)}
.panel img{width:100%;border-radius:8px}
textarea{width:100%;min-height:240px;border:1px solid #ddd;border-radius:8px;padding:14px;resize:vertical}
.controls{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-top:22px}
.btn{border:none;border-radius:24px;padding:12px 28px;font-size:1em;font-weight:600;cursor:pointer;transition:.3s;color:#fff}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2)}
.btn-success{background:#28a745}.btn-secondary{background:#6c757d}
.btn:hover{transform:translateY(-2px);opacity:.92}
.loading{display:none;text-align:center;margin:24px 0;color:#667eea}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:0 auto 10px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 20px;border-radius:8px;font-size:.9em;opacity:0;transition:.4s}
.toast.show{opacity:.9}
</style>
</head><body>
<div class="container">
  <h1>✍️ 手書きメモ → Word変換</h1>
  <p class="subtitle">写真に撮ったメモを編集可能な Word 文書へ</p>

  <!-- ================== アップロード UI ================== -->
  <div class="upload-zone">
    <div style="font-size:4em;margin-bottom:12px">📸</div>
    <input type="file" id="imageInput" accept="image/*" class="file-input">
    <button class="upload-btn" onclick="imageInput.click()">画像を選択</button>
    <p style="margin-top:14px;color:#666">JPG / PNG / WebP  |  最大5 MB</p>
  </div>

  <!-- ================== 進行表示 ================== -->
  <div id="loading" class="loading">
    <div class="spinner"></div><p id="loadingMsg">画像を解析中...</p>
  </div>

  <!-- ================== プレビュー ================== -->
  <section id="previewSection" style="display:none">
    <div class="preview-wrap">
      <div class="panel">
        <h3>📷 アップロード画像</h3>
        <img id="previewImage" alt="preview">
      </div>
      <div class="panel">
        <h3>📝 抽出されたテキスト</h3>
        <textarea id="textOutput" placeholder="ここにOCR結果が表示"></textarea>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="processImage()">🔍 テキスト抽出</button>
      <button class="btn btn-success" onclick="downloadWord()">📄 Word ダウンロード</button>
      <button class="btn btn-secondary" onclick="resetAll()">🔄 リセット</button>
    </div>
  </section>
</div>

<!-- ===== トースト通知 ===== -->
<div id="toast" class="toast"></div>

<!-- ================== ロジック ================== -->
<script>
/* ---------- DOM 取得 ---------- */
const imgInput  = document.getElementById('imageInput');
const previewIm = document.getElementById('previewImage');
const previewSt = document.getElementById('previewSection');
const textArea  = document.getElementById('textOutput');
const loading   = document.getElementById('loading');
const loadingMsg= document.getElementById('loadingMsg');
const toastBox  = document.getElementById('toast');

/* ---------- 状態 ---------- */
let currentFile  = null;
let docxReady    = !!window.docx;   // 既に読めていれば true
let loadingToast = null;

/* ---------- トースト ---------- */
function toast(msg,duration=3000){
  toastBox.textContent=msg;
  toastBox.classList.add('show');
  clearTimeout(loadingToast);
  loadingToast=setTimeout(()=>toastBox.classList.remove('show'),duration);
}

/* ---------- 画像選択 ---------- */
imgInput.addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f) return;
  if(f.size>5*1024*1024){toast('5 MB 以内の画像を選択してください');return;}
  currentFile=f;
  previewIm.src=URL.createObjectURL(f);
  previewSt.style.display='block';
  textArea.value='';
});

/* ---------- 簡易前処理 (グレースケール & 二値化) ---------- */
function preprocess(file){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const cvs=document.createElement('canvas');
      cvs.width=img.naturalWidth; cvs.height=img.naturalHeight;
      const ctx=cvs.getContext('2d');
      ctx.drawImage(img,0,0);
      const id=ctx.getImageData(0,0,cvs.width,cvs.height);
      const data=id.data;
      for(let i=0;i<data.length;i+=4){
        const gray=data[i]*0.299+data[i+1]*0.587+data[i+2]*0.114;
        const bin=gray>200?255:0;        // threshold=200
        data[i]=data[i+1]=data[i+2]=bin; // 白黒のみ
      }
      ctx.putImageData(id,0,0);
      cvs.toBlob(b=>res(b),'image/png');
    };
    img.src=URL.createObjectURL(file);
  });
}

/* ---------- OCR ---------- */
async function processImage(){
  if(!currentFile){toast('先に画像を選択');return;}

  loading.style.display='block';
  loadingMsg.textContent='前処理中...';

  const blob=await preprocess(currentFile);

  loadingMsg.textContent='テキスト認識エンジン起動中...';

  try{
    const {data:{text}}=await Tesseract.recognize(
      blob,'eng',      // ★英語専用モデルに絞る
      { logger:m=>{
          if(m.status==='recognizing text'){
            loadingMsg.innerHTML=`認識中... ${Math.round(m.progress*100)}%`;
          }
        }
      }
    );
    textArea.value=text.trim();
    loading.style.display='none';
    if(!text.trim()) toast('文字を認識できませんでした',4000);
  }catch(err){
    console.error(err);
    toast('OCR でエラーが発生しました');
    loading.style.display='none';
  }
}

/* ---------- Word 生成 ---------- */
async function ensureDocx(){
  if(docxReady) return;
  try{
    await new Promise((ok,ng)=>{
      const s=document.createElement('script');
      s.src='https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js';
      s.onload=()=>{docxReady=true;ok();};
      s.onerror=ng;
      document.head.appendChild(s);
    });
  }catch{ /* ignore; fallback will trigger */ }
}

async function downloadWord(){
  const txt=textArea.value.trim();
  if(!txt){toast('テキストがありません');return;}

  await ensureDocx();

  /* ---------- docx 成功パス ---------- */
  if(window.docx){
    try{
      const {Document,Packer,Paragraph,TextRun}=docx;
      const paras=txt.split(/\r?\n/).map(l=>new Paragraph({children:[new TextRun(l)]}));
      const doc=new Document({sections:[{children:paras}]});
      const blob=await Packer.toBlob(doc);
      const href=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=href;
      a.download=`handwriting_${Date.now()}.docx`;
      document.body.appendChild(a);a.click();a.remove();
      URL.revokeObjectURL(href);
      return;
    }catch(e){console.error(e);}
  }

  /* ---------- フォールバック：RTF ---------- */
  toast('docx ライブラリ読み込み失敗 → RTF で保存します',4000);
  const rtf=`{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0 ${txt.replace(/\n/g,'\\par ')}}`;
  const blob=new Blob([rtf],{type:'application/rtf'});
  const link=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=link;a.download=`handwriting_${Date.now()}.rtf`;
  document.body.appendChild(a);a.click();a.remove();
  URL.revokeObjectURL(link);
}

/* ---------- Reset ---------- */
function resetAll(){
  currentFile=null;imgInput.value='';
  previewSt.style.display='none';textArea.value='';
}
</script>
</body></html>
