<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>手書きメモ → Word変換</title>

<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.4.0/docx.umd.min.js" defer></script>

<!-- ★ 最低限のスタイルだけ残して短縮版 ★ -->
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Hiragino Kaku Gothic ProN',sans-serif}
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#2c3e50}
.container{max-width:1100px;margin:0 auto;background:#fff;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
h1{text-align:center;font-size:2.4em;font-weight:700;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.subtitle{text-align:center;margin-bottom:35px;color:#555}

.upload-section{border:2px dashed #bbb;border-radius:15px;padding:40px 20px;text-align:center;margin-bottom:30px;transition:.3s}
.upload-section:hover{border-color:#667eea;background:#f0f4ff}
.file-input{position:absolute;width:100%;height:100%;opacity:0;cursor:pointer;top:0;left:0}
.upload-button{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;border:none;padding:15px 35px;border-radius:25px;font-size:1.1em;cursor:pointer;box-shadow:0 4px 15px rgba(102,126,234,.3);transition:.3s}
.upload-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
.upload-text{margin-top:15px;color:#666}

.preview-container{display:flex;gap:20px;flex-wrap:wrap}
.image-preview,.text-preview{flex:1 1 320px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.image-preview img{width:100%;border-radius:8px}
.text-output{width:100%;min-height:200px;border:1px solid #ddd;border-radius:8px;padding:15px;resize:vertical}
.controls{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin-top:20px}
.btn{padding:12px 25px;border:none;border-radius:25px;font-size:1em;cursor:pointer;font-weight:600;transition:.3s}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
.btn-success{background:#28a745;color:#fff}.btn-secondary{background:#6c757d;color:#fff}
.btn:hover{transform:translateY(-2px)}
.processing-indicator{display:none;text-align:center;margin:20px 0;color:#667eea}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:38px;height:38px;animation:spin 1s linear infinite;margin:0 auto 10px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>

<body>
<div class="container">

  <h1>✍️ 手書きメモ → Word変換</h1>
  <p class="subtitle">写真に撮った手書きのメモを編集可能な Word 文書に変換</p>

  <!-- アップロード -->
  <div class="upload-section">
    <div style="position:relative;display:inline-block">
      <span style="font-size:4em">📸</span><br>
      <input type="file" class="file-input" id="imageInput" accept="image/*">
      <button class="upload-button" onclick="imageInput.click()">画像を選択</button>
    </div>
    <p class="upload-text">JPG, PNG, WebP | 最大 5 MB</p>
  </div>

  <!-- インジケータ -->
  <div class="processing-indicator" id="processingIndicator">
    <div class="spinner"></div><p>画像を解析中...</p>
  </div>

  <!-- プレビュー -->
  <section id="previewSection" style="display:none">
    <div class="preview-container">
      <div class="image-preview">
        <h3>📷 アップロード画像</h3>
        <img id="previewImage" alt="プレビュー">
      </div>
      <div class="text-preview">
        <h3>📝 抽出されたテキスト</h3>
        <textarea id="textOutput" class="text-output" placeholder="ここに抽出されたテキストが表示されます"></textarea>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" onclick="processImage()">🔍 テキスト抽出</button>
      <button class="btn btn-success" onclick="downloadWord()">📄 Word をダウンロード</button>
      <button class="btn btn-secondary" onclick="resetForm()">🔄 リセット</button>
    </div>
  </section>

</div>

<!-- ===== ここからスクリプト ===== -->
<script defer>
let currentImage=null;

const imgInput   = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImage');
const textArea   = document.getElementById('textOutput');
const processing = document.getElementById('processingIndicator');
const section    = document.getElementById('previewSection');

imgInput.addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f) return;
  if(f.size>5*1024*1024){alert('5 MB までです');return;}
  currentImage=f;
  previewImg.src=URL.createObjectURL(f);
  section.style.display='block';
  textArea.value='';
});

async function processImage(){
  if(!currentImage){alert('画像を選択してください');return;}

  processing.style.display='block';
  processing.innerHTML='<div class="spinner"></div><p>初期化中...</p>';

  const {data:{text}} = await Tesseract.recognize(
    currentImage,
    'jpn+eng',
    {
      corePath  :'https://unpkg.com/tesseract.js-core@4.0.2/tesseract-core.wasm.js',
      workerPath:'https://unpkg.com/tesseract.js@4.1.1/dist/worker.min.js',
      langPath  :'https://tessdata.projectnaptha.com/4.0.0',
      logger:m=>{
        if(m.status==='recognizing text'){
          processing.innerHTML=`<div class="spinner"></div><p>テキスト認識中... ${Math.round(m.progress*100)}%</p>`;
        }
      }
    }
  );

  textArea.value=text;
  processing.style.display='none';
  if(!text.trim()) alert('テキストを認識できませんでした');
}

async function downloadWord(){
  const txt=textArea.value.trim();
  if(!txt){alert('テキストがありません');return;}

  const {Document,Packer,Paragraph,TextRun}=docx;
  const paragraphs=txt.split(/\r?\n/).map(l=>new Paragraph({children:[new TextRun(l)]}));
  const doc=new Document({sections:[{children:paragraphs}]});
  const blob=await Packer.toBlob(doc);

  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`手書きメモ_${new Date().toISOString().slice(0,10)}.docx`;
  document.body.appendChild(a);a.click();a.remove();
}

function resetForm(){
  currentImage=null;imgInput.value='';
  section.style.display='none';processing.style.display='none';textArea.value='';
}

// グローバル公開（ボタンの onclick 用）
window.processImage=processImage;
window.downloadWord=downloadWord;
window.resetForm=resetForm;
</script>
</body>
</html>
